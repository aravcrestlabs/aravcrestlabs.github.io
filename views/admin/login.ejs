<%- include('../partials/header', { title: 'Admin Access' }) %>

    <section class="section" style="min-height: 80vh; display: flex; align-items: center; justify-content: center;">
        <div class="container">
            <div class="pricing-card reveal-scale" style="max-width: 500px; margin: 0 auto;">
                <div class="section-header" style="text-align: center; margin-bottom: 2rem;">
                    <div class="section-tag" style="background: #000; color: #fff;">Restricted Area</div>
                    <h2 style="font-size: 2rem;">Command & <span class="accent">Control</span></h2>
                    <p>Enter your initialization key to access the system.</p>
                </div>

                <form id="login-form">
                    <div class="form-group">
                        <label for="admin-secret">Admin Secret Key</label>
                        <input type="password" id="admin-secret" required placeholder="••••••••••••••••"
                            style="font-family: monospace; letter-spacing: 0.2em;">
                    </div>

                    <div style="margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary w-full">Initialize Session</button>
                    </div>

                    <p id="login-error" class="hidden"
                        style="color: red; margin-top: 1rem; text-align: center; font-weight: bold;">
                        Invalid Key Format
                    </p>
                </form>
            </div>
        </div>
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Configuration
            const API_URL = 'https://uigmdykavqllplgdxtxs.supabase.co/functions/v1/licensing';
            const ADMIN_SECRET_KEY = 'adminSecret';
            const BASE_PATH = '<%= path %>';

            // Check if already logged in (optimistic check, dashboard will kick out if invalid)
            if (localStorage.getItem(ADMIN_SECRET_KEY)) {
                window.location.href = BASE_PATH + 'admin/dashboard<%= ext %>';
            }

            const form = document.getElementById('login-form');
            const input = document.getElementById('admin-secret');
            const errorMsg = document.getElementById('login-error');
            const btn = form.querySelector('button');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const secret = input.value.trim();

                if (secret.length === 0) {
                    errorMsg.textContent = 'Please enter a key.';
                    errorMsg.classList.remove('hidden');
                    return;
                }

                // UI Loading State
                btn.textContent = 'Verifying...';
                btn.disabled = true;
                errorMsg.classList.add('hidden');

                try {
                    // Verify against server by attempting to fetch licenses (limit 1 for speed)
                    // We use the same endpoint the dashboard uses.
                    const res = await fetch(`${API_URL}/licenses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-secret': secret
                        }
                    });

                    if (res.ok) {
                        // Success!
                        localStorage.setItem(ADMIN_SECRET_KEY, secret);
                        window.location.href = BASE_PATH + 'admin/dashboard<%= ext %>';
                    } else {
                        throw new Error('Invalid Secret');
                    }
                } catch (err) {
                    console.error(err);
                    errorMsg.textContent = 'Access Denied: Invalid Key';
                    errorMsg.classList.remove('hidden');
                    btn.textContent = 'Initialize Session';
                    btn.disabled = false;
                }
            });
        });
    </script>

    <%- include('../partials/footer') %>