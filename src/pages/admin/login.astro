---
import Layout from '../../layouts/Layout.astro';
---

<Layout title="Admin Login">
    <section class="section" style="min-height: 80vh; display: flex; align-items: center; justify-content: center;">
        <div class="container">
            <div class="pricing-card reveal-scale" style="max-width: 500px; margin: 0 auto;">
                <div class="section-header" style="text-align: center; margin-bottom: 2rem;">
                    <div class="section-tag" style="background: #000; color: #fff;">Restricted Area</div>
                    <h2 style="font-size: 2rem;">Command & <span class="accent">Control</span></h2>
                    <p>Enter your initialization key to access the system.</p>
                </div>

                <form id="login-form">
                    <div class="form-group">
                        <label for="admin-secret">Admin Secret Key</label>
                        <input type="password" id="admin-secret" required placeholder="••••••••••••••••"
                            style="font-family: monospace; letter-spacing: 0.2em;">
                    </div>

                    <div style="margin-top: 2rem;">
                        <button type="submit" class="btn btn-primary w-full">Initialize Session</button>
                    </div>

                    <p id="login-error" class="hidden"
                        style="color: red; margin-top: 1rem; text-align: center; font-weight: bold;">
                        Invalid Key Format
                    </p>
                </form>
            </div>
        </div>
    </section>

    <script is:inline>
        document.addEventListener('DOMContentLoaded', () => {
            const API_URL = window.GEMCREST_CONFIG?.serverUrl || 'https://uigmdykavqllplgdxtxs.supabase.co/functions/v1/licensing';

            // Check if already logged in
            if (localStorage.getItem('adminSecret')) {
                window.location.href = '/admin/dashboard';
                return;
            }

            const form = document.getElementById('login-form');
            const input = document.getElementById('admin-secret');
            const errorEl = document.getElementById('login-error');
            const submitBtn = form.querySelector('button[type="submit"]');

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const secret = input.value.trim();
                errorEl.classList.add('hidden');

                if (secret.length === 0) {
                    errorEl.textContent = 'Please enter a secret key';
                    errorEl.classList.remove('hidden');
                    return;
                }

                // Disable UI while validating
                submitBtn.disabled = true;
                submitBtn.textContent = 'Verifying...';
                input.disabled = true;

                try {
                    const res = await fetch(`${API_URL}/licenses`, {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-admin-secret': secret
                        }
                    });

                    if (!res.ok) {
                        if (res.status === 401) {
                            throw new Error('Invalid Admin Secret');
                        }
                        throw new Error('Server error (' + res.status + ')');
                    }

                    const data = await res.json();
                    if (!data || !data.licenses) {
                        throw new Error('Invalid server response');
                    }

                    // Secret is valid — store and redirect
                    localStorage.setItem('adminSecret', secret);
                    window.location.href = '/admin/dashboard';
                } catch (err) {
                    console.error('Login failed:', err);
                    errorEl.textContent = err.message || 'Login failed';
                    errorEl.classList.remove('hidden');
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Initialize Session';
                    input.disabled = false;
                    input.focus();
                }
            });
        });
    </script>
</Layout>
